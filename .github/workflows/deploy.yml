name: CI-CD for Microservices

on:
  push:
    branches: ["main"]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to ECR
      run: |
        aws ecr get-login-password --region ${{ secrets.AWS_REGION }} |
        docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

    # USERS Build & Push
    - run: docker build -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/service-users:latest ./service-users
    - run: docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/service-users:latest

    # PRODUCTS Build & Push
    - run: docker build -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/service-products:latest ./service-products
    - run: docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/service-products:latest

    # ORDERS Build & Push
    - run: docker build -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/service-orders:latest ./service-orders
    - run: docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/service-orders:latest

    # SSH into Bastion Host
    - name: SSH into Bastion
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.BASTION_IP }}
        username: ec2-user
        key: ${{ secrets.BASTION_KEY }}
        script: |
          echo "Logged into Bastion successfully!"
          ls -la
          cat private-ec2

    - name: SSH into Bastion and then Private EC2
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.BASTION_IP }}
        username: ec2-user
        key: ${{ secrets.BASTION_KEY }}
        script: |
          echo "âž¡ Logged into Bastion"
          ls -la   # You asked for this
          cat private-ec2  # You requested
          chmod 400 private-ec2

          echo "âž¡ Now connecting to Private EC2..."
          ssh -i private-ec2 -o StrictHostKeyChecking=no ec2-user@10.0.3.169 << 'EOF'
            echo "ðŸŽ‰ Inside Private EC2!"
            hostname
            docker ps
          EOF

    - name: SSH into Bastion and then Private EC2
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.BASTION_IP }}
        username: ec2-user
        key: ${{ secrets.BASTION_KEY }}
        script: |
          echo "âž¡ Logged into Bastion"
          ls -la
          chmod 400 private-ec2  # protect key

          echo "âž¡ Connecting to Private EC2..."
          ssh -i private-ec2 -o StrictHostKeyChecking=no ec2-user@10.0.3.169 << 'EOF'
            echo "ðŸŽ‰ Inside Private EC2!"

            echo "ðŸš« Stopping Old Containers"
            docker stop service-orders service-products service-users || true
            docker rm service-orders service-products service-users || true

            echo "ðŸ“¥ Pulling Latest Images"
            docker pull 324037317595.dkr.ecr.eu-north-1.amazonaws.com/service-users:latest
            docker pull 324037317595.dkr.ecr.eu-north-1.amazonaws.com/service-orders:latest
            docker pull 324037317595.dkr.ecr.eu-north-1.amazonaws.com/service-products:latest

            echo "ðŸš€ Starting Services (latest image)"

            docker run -d \
              --name service-users \
              -p 3001:3001 \
              -e DB_HOST=database-2.c7osg4ocqvq4.eu-north-1.rds.amazonaws.com \
              -e DB_USER=admin \
              -e DB_PASSWORD=rootpass \
              -e DB_NAME=microdb \
              --restart unless-stopped \
              324037317595.dkr.ecr.eu-north-1.amazonaws.com/service-users:latest

            docker run -d \
              --name service-products \
              -p 3002:3002 \
              -e DB_HOST=database-2.c7osg4ocqvq4.eu-north-1.rds.amazonaws.com \
              -e DB_USER=admin \
              -e DB_PASSWORD=rootpass \
              -e DB_NAME=microdb \
              --restart unless-stopped \
              324037317595.dkr.ecr.eu-north-1.amazonaws.com/service-products:latest

            docker run -d \
              --name service-orders \
              -p 3003:3003 \
              -e DB_HOST=database-2.c7osg4ocqvq4.eu-north-1.rds.amazonaws.com \
              -e DB_USER=admin \
              -e DB_PASSWORD=rootpass \
              -e DB_NAME=microdb \
              --restart unless-stopped \
              324037317595.dkr.ecr.eu-north-1.amazonaws.com/service-orders:latest

            echo "âœ… Deployment Successful!"
            docker ps
          EOF

